let currentPatientId = "NEW";
const WEB_APP_URL = 'YOUR_URL_HERE'; // Keep your URL here

async function sendMessage() {
    const input = document.getElementById('userInput');
    const box = document.getElementById('chat-box');
    const text = input.value.trim();
    if (!text) return;

    box.innerHTML += `<div class="msg user">${text}</div>`;
    input.value = '';
    
    const botBubble = document.createElement('div');
    botBubble.className = "msg bot";
    botBubble.innerHTML = "<i>Hakeem's assistant is analyzing symptoms...</i>";
    box.appendChild(botBubble);
    box.scrollTop = box.scrollHeight;

    try {
        // 1. Send data to Google
        await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({message: text, patientId: currentPatientId}) });

        // 2. Persistent Polling (Checks every 3 seconds for up to 30 seconds)
        let attempts = 0;
        const checkReply = setInterval(async () => {
            attempts++;
            try {
                const response = await fetch(WEB_APP_URL);
                const data = await response.json();
                
                // If we get a real reply (not the old welcome message)
                if (data.reply && !data.reply.includes("full name and age")) {
                    botBubble.innerHTML = `<b>[ID: ${data.patientId}]</b><br>${data.reply}`;
                    currentPatientId = data.patientId;
                    clearInterval(checkReply); // STOP waiting once we have the answer
                }
            } catch (e) { console.log("Still waiting for AI..."); }

            if (attempts > 10) { 
                clearInterval(checkReply);
                botBubble.innerHTML = "Analysis complete in ledger. Please check with the clinic directly.";
            }
        }, 3000);

    } catch (error) {
        botBubble.innerHTML = "Connection Error. Please try again.";
    }
}
